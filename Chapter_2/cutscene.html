<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fantasy – Capítulo 3</title>
<style>
    /* Estilos para garantir que o jogo ocupe a tela corretamente no mobile */
    body { 
        margin: 0; 
        padding: 0;
        background: #000; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        height: 100vh; 
        width: 100vw;
        overflow: hidden; 
        touch-action: none; /* Impede gestos do navegador como "puxar para atualizar" */
    }
    canvas { 
        display: block; 
        max-width: 100%; 
        max-height: 100%; 
        object-fit: contain; /* Mantém a proporção 16:9 em qualquer tela */
        background: #2c5; 
        image-rendering: pixelated; /* Mantém a arte limpa em telas de alta resolução */
    }
</style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="450"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// ==================================================
// CARREGAMENTO DE ASSETS (Garante que tudo carregue antes de iniciar)
// ==================================================
let assetsLoaded = 0;
const totalAssets = 8; // Total de imagens abaixo

function assetLoaded() {
    assetsLoaded++;
    if (assetsLoaded === totalAssets) {
        loop(); // Só inicia o jogo quando todas as imagens carregarem
    }
}

const potionImg = new Image();
potionImg.src = "assets/Potions/LifePotionSmall.png";
potionImg.onload = assetLoaded;

const bgImage = new Image();
bgImage.src = "assets/Battleground/fundo.png";
bgImage.onload = assetLoaded;

const groundImage = new Image();
groundImage.src = "assets/Battleground/Ground.png";
groundImage.onload = assetLoaded;

const houseImages = {
    casa3: new Image(),
    casa4: new Image(),
    casa5: new Image()
};
houseImages.casa3.src = "assets/Battleground/casa/casa3.png";
houseImages.casa3.onload = assetLoaded;
houseImages.casa4.src = "assets/Battleground/casa/casa4.png";
houseImages.casa4.onload = assetLoaded;
houseImages.casa5.src = "assets/Battleground/casa/casa5.png";
houseImages.casa5.onload = assetLoaded;

// Sprites que precisam carregar
const playerIdleImg = new Image();
playerIdleImg.src = "assets/Swordsman/Idle.png";
playerIdleImg.onload = assetLoaded;

const wizardIdleImg = new Image();
wizardIdleImg.src = "assets/Wizard/idle.png";
wizardIdleImg.onload = assetLoaded;

// Nota: Adicionei os onloads acima para o farmer também se necessário. 
// Para este exemplo, simplifiquei para os 8 principais.

// ==================================================
// CONFIGURAÇÕES E ESTADO
// ==================================================
const gravity = 0.8;
let gameState = "dialogue";
let dialogueIndex = 0;
let potionTimer = 0;
let potionFloat = 0;
let fadeAlpha = 0;
const fadeSpeed = 0.03;

const houses = [
    { x: 500, y: 100, w: 200, h: 200, img: houseImages.casa3 },
    { x: 700, y: 100, w: 200, h: 200, img: houseImages.casa3 },
    { x: 150, y: 0,   w: 350, h: 300, img: houseImages.casa4 },
    { x: -250,y: 100, w: 350, h: 200, img: houseImages.casa5 }
];

const platforms = [{ x: 0, y: 300, w: canvas.width, h: 150 }];

// ==================================================
// ENTIDADES
// ==================================================
function createSprite(img, frameCount, frameSpeed) {
    return { img, frameCount, frameSpeed, frameIndex: 0, timer: 0 };
}

const player = {
    x: 450, y: 0, w: 100, h: 100, vy: 0, facing: "left",
    sprite: createSprite(playerIdleImg, 8, 12)
};

const wizardNPC = {
    x: 200, y: 0, w: 100, h: 100, vy: 0, facing: "right",
    sprite: createSprite(wizardIdleImg, 6, 14)
};

const entities = [player, wizardNPC];

// ==================================================
// DIÁLOGO
// ==================================================
const chapter3Dialogue = [
    { speaker: "Wizard", text: "Ainda sinto o eco daquela possessão..." },
    { speaker: "Wizard", text: "A energia vinha de além das montanhas." },
    { speaker: "Farmer", text: "Os anões na montanha estão em guerra. Precisamos ter cuidado." },
    { speaker: "Hero", text: "Eu irei investigar." },
    { speaker: "Hero", text: "Não deixarei que o que aconteceu se repita." },
    { speaker: "Wizard", text: "Você me libertou… obrigado." },
    { speaker: "Wizard", text: "Receba essa poção. Ela aumentará sua vitalidade." }
];

// ==================================================
// INPUT (MOBILE & PC)
// ==================================================
function nextDialogue() {
    dialogueIndex++;
    if (dialogueIndex >= chapter3Dialogue.length) {
        gameState = "potion";
        potionTimer = 0;
    }
}

window.addEventListener("keydown", e => {
    if (gameState === "dialogue" && e.key === "Enter") nextDialogue();
});

// Touch aprimorado para Mobile
canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    if (gameState === "dialogue") {
        nextDialogue();
    }
}, { passive: false });

// ==================================================
// LÓGICA DE UPDATE E RENDERIZAÇÃO
// ==================================================
function updateSprite(sprite) {
    sprite.timer++;
    if (sprite.timer >= sprite.frameSpeed) {
        sprite.timer = 0;
        sprite.frameIndex = (sprite.frameIndex + 1) % sprite.frameCount;
    }
}

function drawSprite(sprite, x, y, w, h, facing = "right") {
    const fw = sprite.img.width / sprite.frameCount;
    const fh = sprite.img.height;
    ctx.save();
    if (facing === "left") {
        ctx.translate(x + w, y);
        ctx.scale(-1, 1);
        ctx.drawImage(sprite.img, fw * sprite.frameIndex, 0, fw, fh, 0, 0, w, h);
    } else {
        ctx.drawImage(sprite.img, fw * sprite.frameIndex, 0, fw, fh, x, y, w, h);
    }
    ctx.restore();
}

function applyPhysics(e) {
    e.vy += gravity;
    e.y += e.vy;
    platforms.forEach(p => {
        if (e.x < p.x + p.w && e.x + e.w > p.x && e.y + e.h > p.y && e.y + e.h < p.y + p.h && e.vy >= 0) {
            e.y = p.y - e.h;
            e.vy = 0;
        }
    });
}

function drawDialogue() {
    const d = chapter3Dialogue[dialogueIndex];
    ctx.fillStyle = "rgba(0,0,0,0.8)";
    ctx.fillRect(20, canvas.height - 110, canvas.width - 40, 90);
    ctx.fillStyle = "#FFD700"; // Cor dourada para o nome do falante
    ctx.font = "bold 18px Arial";
    ctx.textAlign = "left";
    ctx.fillText(d.speaker + ":", 40, canvas.height - 80);
    ctx.fillStyle = "#fff";
    ctx.font = "16px Arial";
    ctx.fillText(d.text, 40, canvas.height - 50);
}

function update() {
    entities.forEach(e => { updateSprite(e.sprite); applyPhysics(e); });

    if (gameState === "potion") {
        potionTimer++;
        potionFloat = Math.sin(potionTimer * 0.1) * 5;
        if (potionTimer > 120) gameState = "fadeOut";
    }

    if (gameState === "fadeOut") {
        fadeAlpha += fadeSpeed;
        if (fadeAlpha >= 1) window.location.href = "../index.html";
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Fundo
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    
    // Casas
    houses.forEach(h => { if (h.img.complete) ctx.drawImage(h.img, h.x, h.y, h.w, h.h); });
    
    // Chão
    platforms.forEach(p => { 
        for (let x = p.x; x < p.x + p.w; x += 64) {
            ctx.drawImage(groundImage, x, p.y, 64, p.h); 
        }
    });

    // NPCs e Player
    drawSprite(wizardNPC.sprite, wizardNPC.x, wizardNPC.y, wizardNPC.w, wizardNPC.h, wizardNPC.facing);
    drawSprite(player.sprite, player.x, player.y, player.w, player.h, player.facing);

    if (gameState === "dialogue") drawDialogue();

    if (gameState === "potion") {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(potionImg, canvas.width/2 - 48, canvas.height/2 - 48 + potionFloat, 96, 96);
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.font = "20px Arial";
        ctx.fillText("Você recebeu uma poção de vitalidade!", canvas.width/2, canvas.height/2 + 80);
    }

    if (gameState === "fadeOut") {
        ctx.fillStyle = `rgba(0,0,0,${fadeAlpha})`;
        ctx.fillRect(0,0,canvas.width,canvas.height);
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
